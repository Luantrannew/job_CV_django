

{% extends "base_generic.html" %}
{% load static %}

{% block content %}
<style>
    /* Main form styling */
    .cv-builder {
    background-color: #f9fafc;
    padding: 40px 0;
    }

    .form-container {
    background-color: #ffffff;
    border-radius: 12px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
    padding: 30px;
    margin-bottom: 30px;
    }

    .form-header {
    text-align: center;
    margin-bottom: 30px;
    }

    .form-title {
    color: #1b1d4d;
    font-size: 2.2rem;
    font-weight: 700;
    margin-bottom: 10px;
    }

    .form-subtitle {
    color: #6c757d;
    font-size: 1rem;
    }

    /* Section styling */
    .form-section {
    margin-bottom: 30px;
    position: relative;
    border-radius: 10px;
    border: 1px solid #eaeaea;
    padding: 25px;
    transition: all 0.3s ease;
    }

    .form-section:hover {
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    border-color: #d0d0d0;
    }

    .section-header {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #f0f0f5;
    }

    .section-icon {
    background-color: #1b1d4d;
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    font-size: 18px;
    }

    .section-title {
    color: #1b1d4d;
    font-weight: 600;
    font-size: 1.4rem;
    margin: 0;
    }

    /* Form controls */
    .form-group {
    margin-bottom: 20px;
    }

    .form-group-inline {
    margin-bottom: 15px;
    }

    .form-label {
    font-weight: 500;
    color: #495057;
    margin-bottom: 8px;
    display: block;
    }

    .form-control {
    border: 1px solid #ced4da;
    border-radius: 8px;
    padding: 10px 12px;
    transition: all 0.2s ease;
    }

    .form-control:focus {
    border-color: #1b1d4d;
    box-shadow: 0 0 0 0.2rem rgba(27, 29, 77, 0.25);
    }

    textarea.form-control {
    min-height: 80px;
    }

    /* Group items (for repeatable sections) */
    .group-item {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid #eaeaea;
    position: relative;
    }

    .group-item:hover {
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
    }

    .group-actions {
    margin-top: 15px;
    display: flex;
    justify-content: flex-end;
    }

    /* Add buttons */
    .add-item-btn {
    display: flex;
    align-items: center;
    background-color: #f0f0f5;
    color: #1b1d4d;
    border: 2px dashed #1b1d4d;
    border-radius: 8px;
    padding: 12px 20px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 10px;
    }

    .add-item-btn:hover {
    background-color: #e6e6f0;
    transform: translateY(-2px);
    }

    .add-item-btn i {
    margin-right: 8px;
    font-size: 16px;
    }

    /* Action buttons */
    .btn {
    border-radius: 8px;
    font-weight: 500;
    padding: 8px 16px;
    transition: all 0.3s ease;
    }

    .btn-primary {
    background-color: #1b1d4d;
    border-color: #1b1d4d;
    }

    .btn-primary:hover {
    background-color: #2a2d6d;
    border-color: #2a2d6d;
    transform: translateY(-2px);
    box-shadow: 0 5px 10px rgba(27, 29, 77, 0.2);
    }

    .btn-danger {
    background-color: #dc3545;
    border-color: #dc3545;
    }

    .btn-danger:hover {
    background-color: #c82333;
    border-color: #bd2130;
    transform: translateY(-2px);
    box-shadow: 0 5px 10px rgba(220, 53, 69, 0.2);
    }

    .btn-submit {
    background-color: #1b1d4d;
    color: white;
    padding: 12px 30px;
    font-weight: 600;
    font-size: 1.1rem;
    border-radius: 50px;
    box-shadow: 0 5px 15px rgba(27, 29, 77, 0.3);
    }

    .btn-submit:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(27, 29, 77, 0.4);
    }

    /* Avatar section */
    .avatar-container {
    text-align: center;
    margin-bottom: 20px;
    }

    .avatar-preview {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    overflow: hidden;
    margin: 0 auto 15px;
    border: 3px solid #1b1d4d;
    background-color: #f0f0f5;
    display: flex;
    align-items: center;
    justify-content: center;
    }

    .avatar-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    }

    .avatar-placeholder {
    color: #1b1d4d;
    font-size: 50px;
    }

    .avatar-upload {
    position: relative;
    display: inline-block;
    }

    .avatar-upload-btn {
    background-color: #1b1d4d;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 8px 15px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    }

    .avatar-upload input[type="file"] {
    position: absolute;
    left: 0;
    top: 0;
    opacity: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
    }

    /* Progress indicator */
    .form-progress {
    position: sticky;
    top: 20px;
    background-color: white;
    border-radius: 12px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
    padding: 20px;
    margin-bottom: 30px;
    z-index: 10;
    }

    .progress-title {
    font-weight: 600;
    color: #1b1d4d;
    margin-bottom: 15px;
    font-size: 1.1rem;
    }

    .progress-bar-container {
    height: 8px;
    background-color: #f0f0f5;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 15px;
    }

    .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #1b1d4d 0%, #3a3d8c 100%);
    border-radius: 4px;
    width: 0%;
    transition: width 0.3s ease;
    }

    .progress-steps {
    display: flex;
    justify-content: space-between;
    }

    .progress-step {
    text-align: center;
    flex: 1;
    position: relative;
    font-size: 0.8rem;
    color: #6c757d;
    }

    .progress-step.active {
    color: #1b1d4d;
    font-weight: 600;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
    .form-container {
    padding: 20px;
    }

    .form-title {
    font-size: 1.8rem;
    }

    .section-title {
    font-size: 1.2rem;
    }
    }

    /* Tooltip styling */
    .custom-tooltip {
    position: relative;
    display: inline-block;
    margin-left: 8px;
    color: #1b1d4d;
    cursor: pointer;
    }

    .tooltip-text {
    visibility: hidden;
    width: 200px;
    background-color: #333;
    color: #fff;
    text-align: center;
    border-radius: 6px;
    padding: 5px;
    position: absolute;
    z-index: 1;
    bottom: 125%;
    left: 50%;
    transform: translateX(-50%);
    opacity: 0;
    transition: opacity 0.3s;
    }

    .custom-tooltip:hover .tooltip-text {
    visibility: visible;
    opacity: 1;
    }
</style>
<div class="cv-builder">
  <div class="container">
      <!-- Progress Tracker -->
      <div class="form-progress">
          <h4 class="progress-title">Tiến độ hoàn thành CV</h4>
          <div class="progress-bar-container">
              <div class="progress-bar" id="progressBar"></div>
          </div>
          <div class="progress-steps">
              <div class="progress-step active" data-section="basic-info">Thông tin cơ bản</div>
              <div class="progress-step" data-section="projects">Dự án</div>
              <div class="progress-step" data-section="experience">Kinh nghiệm</div>
              <div class="progress-step" data-section="skills">Kỹ năng & Ngôn ngữ</div>
          </div>
      </div>

      <!-- Main Form Container -->
      <div class="form-container">
          <div class="form-header">
              <h1 class="form-title">Tạo CV Chuyên Nghiệp</h1>
              <p class="form-subtitle">Hoàn thiện thông tin dưới đây để tạo CV nổi bật và thu hút nhà tuyển dụng</p>
          </div>

          <form method="POST" enctype="multipart/form-data" id="cvForm">
              {% csrf_token %}

              <!-- Hidden Fields -->
              <div hidden>
                  <input type="text" name="student_code" value="{{ student.student_code }}" readonly>
                  <input type="hidden" name="education_count" id="educationCount" value="{{ educations|length }}">
                  <input type="hidden" name="experience_count" id="experienceCount" value="{{ experiences|length }}">
                  <input type="hidden" name="skill_count" id="skillCount" value="{{ skills|length }}">
                  <input type="hidden" name="social_link_count" id="socialLinkCount" value="{{ social_links|length }}">
                  <input type="hidden" name="language_count" id="languageCount" value="{{ languages|length }}">
                  <input type="hidden" name="certification_count" id="certificationCount" value="{{ certifications|length }}">
                  <input type="hidden" name="project_count" id="projectCount" value="{{ projects|length }}">
              </div>

              <!-- Basic Information Section -->
              <div class="form-section" id="basic-info-section">
                  <div class="section-header">
                      <div class="section-icon">
                          <i class="fas fa-user"></i>
                      </div>
                      <h2 class="section-title">Thông tin cơ bản</h2>
                  </div>

                  <div class="row">
                      <div class="col-md-6">
                          <div class="form-group">
                              <label for="cv_name" class="form-label">Tên CV <span class="text-danger">*</span></label>
                              <input type="text" class="form-control" id="cv_name" name="cv_name" value="{{ cv.name }}" placeholder="VD: CV Marketing - Nguyễn Văn A" required>
                          </div>
                      </div>

                      <div class="col-md-6">
                          <div class="avatar-container">
                              <div class="avatar-preview">
                                  {% if cv.avatar %}
                                      <img src="{{ cv.avatar.url }}" alt="Avatar" id="avatarImage">
                                  {% else %}
                                      <div class="avatar-placeholder">
                                          <i class="fas fa-user"></i>
                                      </div>
                                  {% endif %}
                              </div>
                              <div class="avatar-upload">
                                  <button type="button" class="avatar-upload-btn">
                                      <i class="fas fa-camera"></i> Tải ảnh đại diện
                                  </button>
                                  <input type="file" name="avatar" id="avatar" accept="image/*">
                              </div>
                          </div>

                          <div class="crop-container mt-3" style="display: none;">
                              <img id="avatarPreview" src="" alt="Preview" style="max-width: 100%;">
                              <button type="button" class="btn btn-primary mt-2" id="cropButton">Cắt & Lưu</button>
                          </div>
                      </div>
                  </div>

                  <div class="row mt-4">
                      <div class="col-md-6">
                          <div class="form-group">
                              <label class="form-label">Họ và Tên</label>
                              <input type="text" class="form-control" name="student_name" value="{{ student.name }}" readonly>
                              <small class="text-muted">Thông tin này được lấy từ tài khoản của bạn</small>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="form-group">
                              <label class="form-label">Số điện thoại</label>
                              <input type="text" class="form-control" name="phone" value="{{ student.phone }}" readonly>
                              <small class="text-muted">Thông tin này được lấy từ tài khoản của bạn</small>
                          </div>
                      </div>
                  </div>

                  <div class="row">
                      <div class="col-md-6">
                          <div class="form-group">
                              <label class="form-label">Email</label>
                              <input type="email" class="form-control" name="email" value="{{ student.email }}" readonly>
                              <small class="text-muted">Thông tin này được lấy từ tài khoản của bạn</small>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="form-group">
                              <label class="form-label">Liên kết mạng xã hội</label>
                              <div id="socialLinkContainer">
                                  {% for link in social_links %}
                                  <div class="social-link-group group-item">
                                      <div class="row">
                                          <div class="col-md-6">
                                              <div class="form-group-inline">
                                                  <label class="form-label">Link</label>
                                                  <input type="url" class="form-control" name="social_link_{{ forloop.counter0 }}" value="{{ link.link }}" placeholder="LinkedIn, GitHub, Facebook, ...">
                                              </div>
                                          </div>
                                          <div class="col-md-6">
                                              <div class="form-group-inline">
                                                  <label class="form-label">Tên hiển thị</label>
                                                  <input type="text" class="form-control" name="social_link_{{ forloop.counter0 }}_display_name" value="{{ link.displayname_set.first.display_name }}" placeholder="LinkedIn Profile, GitHub, ...">
                                              </div>
                                          </div>
                                      </div>
                                      <div class="group-actions">
                                          <button type="button" class="btn btn-danger btn-sm" onclick="removeSocialLink(this)">
                                              <i class="fas fa-trash-alt"></i> Xóa liên kết
                                          </button>
                                      </div>
                                  </div>
                                  {% endfor %}
                              </div>
                              <button type="button" class="add-item-btn" onclick="addSocialLink()">
                                  <i class="fas fa-plus-circle"></i> Thêm liên kết mạng xã hội
                              </button>
                          </div>
                      </div>
                  </div>

                  <div class="form-group mt-3">
                      <label class="form-label">Giới thiệu bản thân <span class="custom-tooltip"><i class="fas fa-info-circle"></i><span class="tooltip-text">Mô tả ngắn gọn về bản thân, mục tiêu nghề nghiệp và điểm mạnh của bạn.</span></span></label>
                      <textarea class="form-control" name="about_me" id="about_me" rows="4" placeholder="Giới thiệu ngắn gọn về bản thân, kinh nghiệm và mục tiêu nghề nghiệp...">{{ cv.about_me }}</textarea>
                  </div>
              </div>

              <!-- Projects Section -->
              <div class="form-section" id="projects-section">
                  <div class="section-header">
                      <div class="section-icon">
                          <i class="fas fa-project-diagram"></i>
                      </div>
                      <h2 class="section-title">Dự án</h2>
                  </div>

                  <div id="projectContainer">
                      {% for project in projects %}
                      <div class="project-group group-item">
                          <div class="row">
                              <div class="col-md-8">
                                  <div class="form-group-inline">
                                      <label class="form-label">Tên dự án</label>
                                      <input type="text" class="form-control" name="project_{{ forloop.counter0 }}_name" value="{{ project.project_name }}" placeholder="VD: Website E-commerce, App Mobile...">
                                  </div>
                              </div>
                              <div class="col-md-4">
                                  <div class="form-group-inline">
                                      <label class="form-label">Liên kết dự án</label>
                                      <input type="url" class="form-control" name="project_{{ forloop.counter0 }}_link" value="{{ project.project_link.first.link }}" placeholder="https://...">
                                  </div>
                              </div>
                          </div>
                          <div class="form-group-inline">
                              <label class="form-label">Mô tả dự án <span class="custom-tooltip"><i class="fas fa-info-circle"></i><span class="tooltip-text">Mô tả chi tiết dự án, vai trò của bạn, công nghệ sử dụng và kết quả đạt được.</span></span></label>
                              <textarea class="form-control" name="project_{{ forloop.counter0 }}_description" placeholder="Mô tả chi tiết về dự án, vai trò của bạn, công nghệ sử dụng và kết quả đạt được...">{{ project.project_content }}</textarea>
                          </div>
                          <div class="group-actions">
                              <button type="button" class="btn btn-danger btn-sm" onclick="removeProject(this)">
                                  <i class="fas fa-trash-alt"></i> Xóa dự án
                              </button>
                          </div>
                      </div>
                      {% endfor %}
                  </div>
                  <button type="button" class="add-item-btn" onclick="addProject()">
                      <i class="fas fa-plus-circle"></i> Thêm dự án mới
                  </button>
              </div>

              <!-- Experience Section -->
              <div class="form-section" id="experience-section">
                  <div class="section-header">
                      <div class="section-icon">
                          <i class="fas fa-briefcase"></i>
                      </div>
                      <h2 class="section-title">Kinh nghiệm làm việc</h2>
                  </div>

                  <div id="experienceContainer">
                      {% for experience in experiences %}
                      <div class="experience-group group-item">
                          <div class="row">
                              <div class="col-md-6">
                                  <div class="form-group-inline">
                                      <label class="form-label">Tên công ty</label>
                                      <input type="text" class="form-control" name="experience_{{ forloop.counter0 }}_company_name" value="{{ experience.experience.company_name }}" placeholder="VD: Công ty ABC">
                                  </div>
                              </div>
                              <div class="col-md-6">
                                  <div class="form-group-inline">
                                      <label class="form-label">Vị trí</label>
                                      <input type="text" class="form-control" name="experience_{{ forloop.counter0 }}_role" value="{{ experience.experience.role }}" placeholder="VD: Marketing Executive">
                                  </div>
                              </div>
                          </div>
                          <div class="row">
                              <div class="col-md-6">
                                  <div class="form-group-inline">
                                      <label class="form-label">Ngày bắt đầu</label>
                                      <input type="date" class="form-control" name="experience_{{ forloop.counter0 }}_start_date" value="{{ experience.experience.start_date|date:'Y-m-d' }}">
                                  </div>
                              </div>
                              <div class="col-md-6">
                                  <div class="form-group-inline">
                                      <label class="form-label">Ngày kết thúc</label>
                                      <input type="date" class="form-control" name="experience_{{ forloop.counter0 }}_end_date" value="{{ experience.experience.end_date|date:'Y-m-d' }}">
                                      <small class="text-muted">Để trống nếu vẫn đang làm việc</small>
                                  </div>
                              </div>
                          </div>
                          <div class="form-group-inline">
                              <label class="form-label">Mô tả công việc <span class="custom-tooltip"><i class="fas fa-info-circle"></i><span class="tooltip-text">Mô tả nhiệm vụ, thành tựu và trách nhiệm của bạn tại vị trí này.</span></span></label>
                              <textarea class="form-control" name="experience_{{ forloop.counter0 }}_context" placeholder="Mô tả chi tiết về trách nhiệm và thành tựu của bạn tại vị trí này...">{{ experience.experience.context }}</textarea>
                          </div>
                          <div class="group-actions">
                              <button type="button" class="btn btn-danger btn-sm" onclick="removeExperience(this)">
                                  <i class="fas fa-trash-alt"></i> Xóa kinh nghiệm
                              </button>
                          </div>
                      </div>
                      {% endfor %}
                  </div>
                  <button type="button" class="add-item-btn" onclick="addExperience()">
                      <i class="fas fa-plus-circle"></i> Thêm kinh nghiệm làm việc
                  </button>
              </div>

              <!-- Skills & Languages Section -->
              <div class="form-section" id="skills-section">
                  <div class="section-header">
                      <div class="section-icon">
                          <i class="fas fa-clipboard-list"></i>
                      </div>
                      <h2 class="section-title">Kỹ năng & Chứng chỉ</h2>
                  </div>

                  <div class="row">
                      <div class="col-md-6">
                          <h4 class="mb-3">Kỹ năng</h4>
                          <div id="skillContainer">
                              {% for skill in skills %}
                              <div class="skill-group group-item">
                                  <div class="row">
                                      <div class="col-md-9">
                                          <div class="form-group-inline mb-0">
                                              <input type="text" class="form-control" name="skill_{{ forloop.counter0 }}" value="{{ skill.skill.skill }}" placeholder="VD: HTML/CSS, Marketing, Excel...">
                                          </div>
                                      </div>
                                      <div class="col-md-3 d-flex align-items-center">
                                          <button type="button" class="btn btn-danger btn-sm" onclick="removeSkill(this)">
                                              <i class="fas fa-trash-alt"></i>
                                          </button>
                                      </div>
                                  </div>
                              </div>
                              {% endfor %}
                          </div>
                          <button type="button" class="add-item-btn" onclick="addSkill()">
                              <i class="fas fa-plus-circle"></i> Thêm kỹ năng
                          </button>
                      </div>

                      <div class="col-md-6">
                          <h4 class="mb-3">Chứng chỉ</h4>
                          <div id="certificationContainer">
                              {% for certification in certifications %}
                              <div class="certification-group group-item">
                                  <div class="row">
                                      <div class="col-md-9">
                                          <div class="form-group-inline mb-0">
                                              <input type="text" class="form-control" name="certification_{{ forloop.counter0 }}" value="{{ certification.certificate }}" placeholder="VD: TOEIC 750, AWS Certified...">
                                          </div>
                                      </div>
                                      <div class="col-md-3 d-flex align-items-center">
                                          <button type="button" class="btn btn-danger btn-sm" onclick="removeCertification(this)">
                                              <i class="fas fa-trash-alt"></i>
                                          </button>
                                      </div>
                                  </div>
                              </div>
                              {% endfor %}
                          </div>
                          <button type="button" class="add-item-btn" onclick="addCertification()">
                              <i class="fas fa-plus-circle"></i> Thêm chứng chỉ
                          </button>
                      </div>
                  </div>

                  <hr class="my-4">

                  <div class="section-header">
                      <div class="section-icon">
                          <i class="fas fa-language"></i>
                      </div>
                      <h2 class="section-title">Ngôn ngữ</h2>
                  </div>

                  <div id="languageContainer">
                      {% for language in languages %}
                      <div class="language-group group-item">
                          <div class="row">
                              <div class="col-md-5">
                                  <div class="form-group-inline">
                                      <label class="form-label">Ngôn ngữ</label>
                                      <input type="text" class="form-control" name="language_{{ forloop.counter0 }}_name" value="{{ language.language.language }}" placeholder="VD: Tiếng Anh, Tiếng Nhật...">
                                  </div>
                              </div>
                              <div class="col-md-7">
                                  <div class="form-group-inline">
                                      <label class="form-label">Trình độ</label>
                                      <textarea class="form-control" name="language_{{ forloop.counter0 }}_description" placeholder="VD: Thành thạo, IELTS 7.0...">{{ language.language.text }}</textarea>
                                  </div>
                              </div>
                          </div>
                          <div class="group-actions">
                              <button type="button" class="btn btn-danger btn-sm" onclick="removeLanguage(this)">
                                  <i class="fas fa-trash-alt"></i> Xóa ngôn ngữ
                              </button>
                          </div>
                      </div>
                      {% endfor %}
                  </div>
                  <button type="button" class="add-item-btn" onclick="addLanguage()">
                      <i class="fas fa-plus-circle"></i> Thêm ngôn ngữ
                  </button>
              </div>

              <!-- Submit Button -->
              <div class="text-center mt-5">
                  <button type="submit" class="btn btn-submit">
                      <i class="fas fa-save"></i> Hoàn thành và lưu CV
                  </button>
              </div>
          </form>
      </div>
  </div>
</div>

<script>
// Initialize variables for form sections
let experienceCount = parseInt(document.getElementById('experienceCount')?.value || 0);
let socialLinkCount = parseInt(document.getElementById('socialLinkCount')?.value || 0);
let languageCount = parseInt(document.getElementById('languageCount')?.value || 0);
let certificationCount = parseInt(document.getElementById('certificationCount')?.value || 0);
let skillCount = parseInt(document.getElementById('skillCount')?.value || 0);
let projectCount = parseInt(document.getElementById('projectCount')?.value || 0);

// Get CSRF token
const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

// Handle progress bar updates
function updateProgressBar() {
    const totalSections = 8; // Total number of form sections
    let completedSections = 0;

    // Check if CV name is filled
    if (document.getElementById('cv_name').value.trim() !== '') {
        completedSections++;
    }

    // Check if About Me is filled
    if (document.getElementById('about_me').value.trim() !== '') {
        completedSections++;
    }

    // Check if there are social links
    if (document.querySelectorAll('.social-link-group').length > 0) {
        completedSections++;
    }

    // Check if there are projects
    if (document.querySelectorAll('.project-group').length > 0) {
        completedSections++;
    }

    // Check if there are experiences
    if (document.querySelectorAll('.experience-group').length > 0) {
        completedSections++;
    }

    // Check if there are skills
    if (document.querySelectorAll('.skill-group').length > 0) {
        completedSections++;
    }

    // Check if there are certifications
    if (document.querySelectorAll('.certification-group').length > 0) {
        completedSections++;
    }

    // Check if there are languages
    if (document.querySelectorAll('.language-group').length > 0) {
        completedSections++;
    }

    // Calculate percentage
    const percentage = (completedSections / totalSections) * 100;

    // Update progress bar
    document.getElementById('progressBar').style.width = percentage + '%';

    // Update section indicators
    const sections = ['basic-info', 'projects', 'experience', 'skills'];
    sections.forEach((section, index) => {
        const sectionElement = document.querySelector(`.progress-step[data-section="${section}"]`);
        if (index <= Math.floor(completedSections / 2)) {
            sectionElement.classList.add('active');
        } else {
            sectionElement.classList.remove('active');
        }
    });
}

// Avatar handling
document.addEventListener("DOMContentLoaded", function () {
    const avatarInput = document.getElementById("avatar");
    const avatarImage = document.getElementById("avatarImage");
    const avatarPreview = document.getElementById("avatarPreview");
    const cropContainer = document.querySelector(".crop-container");
    const avatarPlaceholder = document.querySelector(".avatar-placeholder");
    const cropButton = document.getElementById("cropButton");
    let cropper;

    // Preview avatar image when selected
    if (avatarInput) {
        avatarInput.addEventListener("change", function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    if (avatarImage) {
                        avatarImage.src = event.target.result;
                    } else if (avatarPlaceholder) {
                        avatarPlaceholder.style.display = 'none';
                        const newImage = document.createElement('img');
                        newImage.src = event.target.result;
                        newImage.id = 'avatarImage';
                        document.querySelector('.avatar-preview').appendChild(newImage);
                    }

                    avatarPreview.src = event.target.result;
                    cropContainer.style.display = "block";

                    if (cropper) {
                        cropper.destroy();
                    }

                    // Initialize Cropper.js
                    cropper = new Cropper(avatarPreview, {
                        aspectRatio: 1,
                        viewMode: 1,
                        movable: true,
                        cropBoxResizable: true,
                    });
                };
                reader.readAsDataURL(file);
            }
        });
    }

    // Handle cropping
    if (cropButton) {
        cropButton.addEventListener("click", function () {
            if (cropper) {
                // Get the cropped canvas
                const canvas = cropper.getCroppedCanvas({
                    width: 170,
                    height: 170,
                });

                // Show loading state
                cropButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                cropButton.disabled = true;

                // Convert canvas to blob and send to server
                canvas.toBlob(function (blob) {
                    // For direct file upload
                    const formData = new FormData();
                    formData.append("avatar", blob, "avatar.jpg");
                    
                    // Add CSRF token
                    formData.append("csrfmiddlewaretoken", csrfToken);

                    // Send to server
                    fetch("/upload-avatar/", {
                        method: "POST",
                        body: formData,
                        headers: {
                            "X-CSRFToken": csrfToken,
                        },
                    })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            // Update the displayed avatar with the cropped version
                            if (avatarImage) {
                                avatarImage.src = canvas.toDataURL();
                            } else {
                                const newImage = document.createElement('img');
                                newImage.src = canvas.toDataURL();
                                newImage.id = 'avatarImage';
                                const previewContainer = document.querySelector('.avatar-preview');
                                previewContainer.innerHTML = '';
                                previewContainer.appendChild(newImage);
                            }
                            
                            // Hide crop container
                            cropContainer.style.display = "none";
                            
                            // Show success message
                            alert("Ảnh đại diện đã được cập nhật thành công!");
                        } else {
                            alert("Lỗi: " + data.message);
                        }
                    })
                    .catch((error) => {
                        console.error("Error:", error);
                        alert("Đã xảy ra lỗi khi tải lên ảnh đại diện. Vui lòng thử lại.");
                    })
                    .finally(() => {
                        // Reset button state
                        cropButton.innerHTML = 'Cắt & Lưu';
                        cropButton.disabled = false;
                    });
                }, 'image/jpeg');
            }
        });
    }

    // Run initial progress check
    updateProgressBar();

    // Add listeners to form fields to update progress
    const cvForm = document.getElementById('cvForm');
    if (cvForm) {
        cvForm.addEventListener('input', updateProgressBar);
    }
});

// Social links management
function addSocialLink() {
    const container = document.getElementById('socialLinkContainer');
    const count = socialLinkCount;

    const newSocialLink = document.createElement('div');
    newSocialLink.className = 'social-link-group group-item';
    newSocialLink.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <div class="form-group-inline">
                    <label class="form-label">Link</label>
                    <input type="url" class="form-control" name="social_link_${count}" placeholder="LinkedIn, GitHub, Facebook, ...">
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group-inline">
                    <label class="form-label">Tên hiển thị</label>
                    <input type="text" class="form-control" name="social_link_${count}_display_name" placeholder="LinkedIn Profile, GitHub, ...">
                </div>
            </div>
        </div>
        <div class="group-actions">
            <button type="button" class="btn btn-danger btn-sm" onclick="removeSocialLink(this)">
                <i class="fas fa-trash-alt"></i> Xóa liên kết
            </button>
        </div>
    `;

    container.appendChild(newSocialLink);
    socialLinkCount++;
    document.getElementById('socialLinkCount').value = socialLinkCount;

    // Update progress
    updateProgressBar();
}

function removeSocialLink(button) {
    const socialLinkGroup = button.closest('.social-link-group');
    if (socialLinkGroup) {
        socialLinkGroup.remove();
        updateProgressBar();
    }
}

// Project management
function addProject() {
    const container = document.getElementById('projectContainer');
    const count = projectCount;

    const newProject = document.createElement('div');
    newProject.className = 'project-group group-item';
    newProject.innerHTML = `
        <div class="row">
            <div class="col-md-8">
                <div class="form-group-inline">
                    <label class="form-label">Tên dự án</label>
                    <input type="text" class="form-control" name="project_${count}_name" placeholder="VD: Website E-commerce, App Mobile...">
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group-inline">
                    <label class="form-label">Liên kết dự án</label>
                    <input type="url" class="form-control" name="project_${count}_link" placeholder="https://...">
                </div>
            </div>
        </div>
        <div class="form-group-inline">
            <label class="form-label">Mô tả dự án <span class="custom-tooltip"><i class="fas fa-info-circle"></i><span class="tooltip-text">Mô tả chi tiết dự án, vai trò của bạn, công nghệ sử dụng và kết quả đạt được.</span></span></label>
            <textarea class="form-control" name="project_${count}_description" placeholder="Mô tả chi tiết về dự án, vai trò của bạn, công nghệ sử dụng và kết quả đạt được..."></textarea>
        </div>
        <div class="group-actions">
            <button type="button" class="btn btn-danger btn-sm" onclick="removeProject(this)">
                <i class="fas fa-trash-alt"></i> Xóa dự án
            </button>
        </div>
    `;

    container.appendChild(newProject);
    projectCount++;
    document.getElementById('projectCount').value = projectCount;

    // Update progress
    updateProgressBar();
}

function removeProject(button) {
    const projectGroup = button.closest('.project-group');
    if (projectGroup) {
        projectGroup.remove();
        updateProgressBar();
    }
}

// Experience management
function addExperience() {
    const container = document.getElementById('experienceContainer');
    const count = experienceCount;

    const newExperience = document.createElement('div');
    newExperience.className = 'experience-group group-item';
    newExperience.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <div class="form-group-inline">
                    <label class="form-label">Tên công ty</label>
                    <input type="text" class="form-control" name="experience_${count}_company_name" placeholder="VD: Công ty ABC">
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group-inline">
                    <label class="form-label">Vị trí</label>
                    <input type="text" class="form-control" name="experience_${count}_role" placeholder="VD: Marketing Executive">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group-inline">
                    <label class="form-label">Ngày bắt đầu</label>
                    <input type="date" class="form-control" name="experience_${count}_start_date">
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group-inline">
                    <label class="form-label">Ngày kết thúc</label>
                    <input type="date" class="form-control" name="experience_${count}_end_date">
                    <small class="text-muted">Để trống nếu vẫn đang làm việc</small>
                </div>
            </div>
        </div>
        <div class="form-group-inline">
            <label class="form-label">Mô tả công việc <span class="custom-tooltip"><i class="fas fa-info-circle"></i><span class="tooltip-text">Mô tả nhiệm vụ, thành tựu và trách nhiệm của bạn tại vị trí này.</span></span></label>
            <textarea class="form-control" name="experience_${count}_context" placeholder="Mô tả chi tiết về trách nhiệm và thành tựu của bạn tại vị trí này..."></textarea>
        </div>
        <div class="group-actions">
            <button type="button" class="btn btn-danger btn-sm" onclick="removeExperience(this)">
                <i class="fas fa-trash-alt"></i> Xóa kinh nghiệm
            </button>
        </div>
    `;

    container.appendChild(newExperience);
    experienceCount++;
    document.getElementById('experienceCount').value = experienceCount;

    // Update progress
    updateProgressBar();
}

function removeExperience(button) {
    const experienceGroup = button.closest('.experience-group');
    if (experienceGroup) {
        experienceGroup.remove();
        updateProgressBar();
    }
}

// Skill management
function addSkill() {
    const container = document.getElementById('skillContainer');
    const count = skillCount;

    const newSkill = document.createElement('div');
    newSkill.className = 'skill-group group-item';
    newSkill.innerHTML = `
        <div class="row">
            <div class="col-md-9">
                <div class="form-group-inline mb-0">
                    <input type="text" class="form-control" name="skill_${count}" placeholder="VD: HTML/CSS, Marketing, Excel...">
                </div>
            </div>
            <div class="col-md-3 d-flex align-items-center">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeSkill(this)">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        </div>
    `;

    container.appendChild(newSkill);
    skillCount++;
    document.getElementById('skillCount').value = skillCount;

    // Update progress
    updateProgressBar();
}

function removeSkill(button) {
    const skillGroup = button.closest('.skill-group');
    if (skillGroup) {
        skillGroup.remove();
        updateProgressBar();
    }
}

// Language management
function addLanguage() {
    const container = document.getElementById('languageContainer');
    const count = languageCount;

    const newLanguage = document.createElement('div');
    newLanguage.className = 'language-group group-item';
    newLanguage.innerHTML = `
        <div class="row">
            <div class="col-md-5">
                <div class="form-group-inline">
                    <label class="form-label">Ngôn ngữ</label>
                    <input type="text" class="form-control" name="language_${count}_name" placeholder="VD: Tiếng Anh, Tiếng Nhật...">
                </div>
            </div>
            <div class="col-md-7">
                <div class="form-group-inline">
                    <label class="form-label">Trình độ</label>
                    <textarea class="form-control" name="language_${count}_description" placeholder="VD: Thành thạo, IELTS 7.0..."></textarea>
                </div>
            </div>
        </div>
        <div class="group-actions">
            <button type="button" class="btn btn-danger btn-sm" onclick="removeLanguage(this)">
                <i class="fas fa-trash-alt"></i> Xóa ngôn ngữ
            </button>
        </div>
    `;

    container.appendChild(newLanguage);
    languageCount++;
    document.getElementById('languageCount').value = languageCount;

    // Update progress
    updateProgressBar();
}

function removeLanguage(button) {
    const languageGroup = button.closest('.language-group');
    if (languageGroup) {
        languageGroup.remove();
        updateProgressBar();
    }
}

// Certification management
function addCertification() {
    const container = document.getElementById('certificationContainer');
    const count = certificationCount;

    const newCertification = document.createElement('div');
    newCertification.className = 'certification-group group-item';
    newCertification.innerHTML = `
        <div class="row">
            <div class="col-md-9">
                <div class="form-group-inline mb-0">
                    <input type="text" class="form-control" name="certification_${count}" placeholder="VD: TOEIC 750, AWS Certified...">
                </div>
            </div>
            <div class="col-md-3 d-flex align-items-center">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeCertification(this)">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        </div>
    `;

    container.appendChild(newCertification);
    certificationCount++;
    document.getElementById('certificationCount').value = certificationCount;

    // Update progress
    updateProgressBar();
}

function removeCertification(button) {
    const certificationGroup = button.closest('.certification-group');
    if (certificationGroup) {
        certificationGroup.remove();
        updateProgressBar();
    }
}

// Smooth scrolling to sections
document.querySelectorAll('.progress-step').forEach(step => {
    step.addEventListener('click', function() {
        const section = this.getAttribute('data-section');
        const sectionElement = document.getElementById(section + '-section');
        if (sectionElement) {
            window.scrollTo({
                top: sectionElement.offsetTop - 100,
                behavior: 'smooth'
            });
        }
    });
});
</script>
{% endblock %}
